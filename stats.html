<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Statistics - Rice Noncanonical ORFome | Ribo-seq Datasets</title>
    <meta name="description" content="Explore 119 Ribo-seq datasets from rice (Oryza sativa) covering multiple tissues and developmental stages. View detailed statistics on ribosome-protected fragments analysis.">
    <meta name="keywords" content="Ribo-seq, rice datasets, tissue-specific, developmental stages, RNA-seq, ribosome profiling, statistics">
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
    <link href="css/styles.css" rel="stylesheet" type="text/css">
    <link href="css/common.css" rel="stylesheet" type="text/css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- DataTables CSS/JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <header>
        <h1>Rice Noncanonical ORFome</h1>
    </header>
    <nav>
        <a href="index.html">Home</a>
        <a href="stats.html">Data Statistics</a>
        <a href="annotations.html">Annotations</a>
        <a href="download.html">Downloads</a>
        <a href="contact.html">Contact</a>
    </nav>

    <!-- Data Visualization Section -->
    <div class="container">
        <div class="card chart-section">
            <h2 style="text-align: center; margin-bottom: 30px;">Data Overview</h2>

            <!-- Charts Container - Flex Layout with Different Sizes -->
            <div style="display: flex; justify-content: center; align-items: center; gap: 50px; flex-wrap: wrap; padding: 20px;">
                <!-- Tissue Distribution Chart (Pie Chart - Smaller) -->
                <div style="flex: 0 0 auto; width: 380px;">
                    <div class="chart-wrapper" style="height: 320px;">
                        <canvas id="tissueDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Development Stage Chart (Bar Chart - Larger) -->
                <div style="flex: 0 1 auto; width: 550px; min-width: 450px;">
                    <div class="chart-wrapper" style="height: 320px;">
                        <canvas id="developmentStageChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <h2>Ribo-seq datasets and coresspoonding RNA-seq used in this study.</h2>
            <div id="table-a-container">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading Ribo-seq dataset information...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>Statistics of Ribo-seq reads number in processing steps.</h2>

            <!-- Processing Pipeline Chart -->
            <div style="display: flex; justify-content: center; margin-bottom: 30px;">
                <div style="width: 100%; max-width: 800px;">
                    <div class="chart-wrapper" style="height: 400px;">
                        <canvas id="processingStepsChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="table-b-container">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading read statistics...</div>
                    <div class="loading-progress">
                        <div class="loading-progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p> Copyright © 2025 Rice Noncanonical ORFome | Laboratory of Development and Disease - School of Life Science, Sun Yat-Sen University </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="js/common.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // DataTables表格生成
            const createTable = (containerId, data, tableId) => {
                const container = document.getElementById(containerId);
                if (!container || !data || data.length === 0) {
                    container.innerHTML = '<p>Error loading data or no data available.</p>';
                    return;
                }
                let html = `<table id="${tableId}" style="width:100%"><thead><tr>`;
                data[0].forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                data.slice(1).forEach(row => {
                    html += '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
                });
                html += '</tbody></table>';
                container.innerHTML = html;
                $(() => {
                    $(`#${tableId}`).DataTable({
                        scrollX: true,
                        paging: true,
                        pageLength: 10,
                        lengthMenu: [10, 25, 50, 100],
                        autoWidth: false
                    });
                });
            };

            const loadCSV = async (filePath, containerId, tableId) => {
                const container = document.getElementById(containerId);
                try {
                    const response = await fetch(filePath);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok. Status: ${response.status}`);
                    }
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: false,
                        skipEmptyLines: true,
                        complete: function(results) {
                            createTable(containerId, results.data, tableId);
                        },
                        error: function(parseError) {
                            throw new Error(`CSV parsing error: ${parseError.message}`);
                        }
                    });
                } catch (error) {
                    container.innerHTML = `<p>Error: Could not load data from <code>${filePath}</code>. Please ensure the file exists on the server.</p>`;
                    console.error('Error loading or parsing CSV:', error);
                }
            };

            // 分别加载两个表格
            loadCSV('res/TableS1A.csv', 'table-a-container', 'myTableA');
            loadCSV('res/TableS1B.csv', 'table-b-container', 'myTableB');

            // 加载并生成可视化图表
            loadCSVAndCreateCharts();
        });

        // 加载CSV数据并创建图表
        async function loadCSVAndCreateCharts() {
            try {
                // 加载TableS1A用于组织分布和发育阶段图表
                const response1 = await fetch('res/TableS1A.csv');
                const csvText1 = await response1.text();

                Papa.parse(csvText1, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        createChartsFromData(results.data);
                    }
                });

                // 加载TableS1B用于处理流程图表
                const response2 = await fetch('res/TableS1B.csv');
                const csvText2 = await response2.text();

                Papa.parse(csvText2, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        createProcessingStepsChart(results.data);
                    }
                });
            } catch (error) {
                console.error('Error loading CSV for charts:', error);
            }
        }

        // 创建处理流程图表
        function createProcessingStepsChart(data) {
            try {
                console.log('Creating processing steps chart with', data.length, 'rows');

                // 健壮的数字解析函数
                const parseNumber = (value) => {
                    if (!value && value !== 0) return 0;
                    // 移除所有非数字字符（除了小数点和负号）
                    const cleaned = String(value).replace(/[^\d.-]/g, '');
                    const num = parseFloat(cleaned);
                    return isNaN(num) ? 0 : num;
                };

                // 查找字段的辅助函数
                const findFieldValue = (row, possibleNames) => {
                    const keys = Object.keys(row);
                    for (let name of possibleNames) {
                        const foundKey = keys.find(k => k.trim() === name);
                        if (foundKey && row[foundKey]) {
                            return parseNumber(row[foundKey]);
                        }
                    }
                    return 0;
                };

                // 初始化总和
                let totalRaw = 0;
                let totalClean = 0;
                let totalRPFs = 0;
                let totalORF = 0;

                // 遍历所有样本，累加每个步骤的数据
                data.forEach((row, index) => {
                    if (index === 0) {
                        console.log('Sample row:', row);
                    }

                    // 使用多种可能的字段名尝试匹配
                    const raw = findFieldValue(row, ['Raw reads number', 'Raw reads']);
                    const clean = findFieldValue(row, ['Clean RPFs number', 'Clean reads number']);
                    const rpfs = findFieldValue(row, ['Uniquely mapped RPFs number', 'RPFs number']);
                    const orf = findFieldValue(row, ['ORF assigned number', 'ORF assigned']);

                    totalRaw += raw;
                    totalClean += clean;
                    totalRPFs += rpfs;
                    totalORF += orf;
                });

                console.log('Totals:', { totalRaw, totalClean, totalRPFs, totalORF });

                // 转换为更易读的格式（Billion, Million）
                const formatNumber = (num) => {
                    if (num >= 1e9) {
                        return (num / 1e9).toFixed(2) + 'B';
                    } else if (num >= 1e6) {
                        return (num / 1e6).toFixed(2) + 'M';
                    } else if (num >= 1e3) {
                        return (num / 1e3).toFixed(2) + 'K';
                    }
                    return num.toFixed(0);
                };

                // 准备图表数据
                const labels = ['Raw Reads', 'Clean RPFs', 'Unique RPFs', 'ORF Assigned'];
                const values = [totalRaw, totalClean, totalRPFs, totalORF];
                const formattedValues = values.map(v => formatNumber(v));

                // 创建垂直条形图
                const ctx = document.getElementById('processingStepsChart');
                if (!ctx) {
                    console.error('Canvas element not found!');
                    return;
                }

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Read Count',
                            data: values,
                            backgroundColor: [
                                '#2c3e50',  // Raw - 深蓝灰
                                '#34495e',  // Clean - 蓝灰
                                '#3498db',  // RPFs - 蓝色
                                '#5dade2'   // ORF - 浅蓝
                            ],
                            borderColor: [
                                '#2c3e50',
                                '#34495e',
                                '#3498db',
                                '#5dade2'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        return formatNumber(value) + ' reads';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatNumber(value);
                                    },
                                    font: {
                                        size: 11
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Number of Reads',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    },
                });

                console.log('Chart created successfully');
            } catch (error) {
                console.error('Error creating processing steps chart:', error);
            }
        }

        // 从数据创建图表
        function createChartsFromData(data) {
            // 提取组织分布数据
            const tissueCounts = {};
            data.forEach(row => {
                const tissue = row.Tissue || 'Unknown';
                tissueCounts[tissue] = (tissueCounts[tissue] || 0) + 1;
            });

            // 提取发育阶段数据
            const stageCounts = {};
            data.forEach(row => {
                const stage = row['Development Stage'] || 'Unknown';
                stageCounts[stage] = (stageCounts[stage] || 0) + 1;
            });

            // 创建组织分布饼图
            const tissueLabels = Object.keys(tissueCounts);
            const tissueValues = Object.values(tissueCounts);
            const tissueColors = [
                '#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b'
            ];

            createPieChart(
                'tissueDistributionChart',
                tissueLabels,
                tissueValues,
                tissueColors.slice(0, tissueLabels.length),
                'Distribution by Tissue Type'
            );

            // 创建发育阶段条形图
            const stageLabels = Object.keys(stageCounts);
            const stageValues = Object.values(stageCounts);

            createHorizontalBarChart(
                'developmentStageChart',
                stageLabels,
                stageValues,
                'Number of Datasets',
                'Distribution by Development Stage'
            );
        }
    </script>
</body>
</html>